#!/bin/bash
# Unity Asset Toolkit - Pre-commit Hook
# Validates Unity meta files before committing

echo "Running Unity pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERROR_COUNT=0
WARNING_COUNT=0

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# ============================================
# Check 1: Meta files for Unity assets
# ============================================
echo "Checking for missing meta files..."

for file in $STAGED_FILES; do
    # Skip if it's a meta file itself
    if [[ "$file" == *.meta ]]; then
        continue
    fi
    
    # Skip if not in Unity project
    if [[ ! "$file" == assets/* ]]; then
        continue
    fi
    
    # Skip Library, Temp, obj folders
    if [[ "$file" == */Library/* ]] || [[ "$file" == */Temp/* ]] || [[ "$file" == */obj/* ]]; then
        continue
    fi
    
    # Check if meta file exists for this asset
    META_FILE="$file.meta"
    if [[ -f "$file" ]] && [[ ! -f "$META_FILE" ]]; then
        echo -e "${RED}[ERROR] Missing meta file: $META_FILE${NC}"
        ERROR_COUNT=$((ERROR_COUNT + 1))
    fi
done

# ============================================
# Check 2: Orphan meta files
# ============================================
echo "Checking for orphan meta files..."

for file in $STAGED_FILES; do
    # Only check meta files
    if [[ ! "$file" == *.meta ]]; then
        continue
    fi
    
    # Get the asset file (remove .meta extension)
    ASSET_FILE="${file%.meta}"
    
    # Check if asset exists
    if [[ ! -f "$ASSET_FILE" ]] && [[ ! -d "$ASSET_FILE" ]]; then
        # Check if asset is also being staged for deletion
        DELETED_FILES=$(git diff --cached --name-only --diff-filter=D)
        if [[ ! "$DELETED_FILES" == *"$ASSET_FILE"* ]]; then
            echo -e "${YELLOW}[WARN] Orphan meta file (no matching asset): $file${NC}"
            WARNING_COUNT=$((WARNING_COUNT + 1))
        fi
    fi
done

# ============================================
# Check 3: Large files not tracked by LFS
# ============================================
echo "Checking for large files not tracked by LFS..."

MAX_SIZE_KB=1024  # 1MB

for file in $STAGED_FILES; do
    if [[ -f "$file" ]]; then
        SIZE=$(du -k "$file" 2>/dev/null | cut -f1)
        if [[ -n "$SIZE" ]] && [[ "$SIZE" -gt "$MAX_SIZE_KB" ]]; then
            # Check if tracked by LFS
            LFS_CHECK=$(git check-attr filter "$file" | grep "lfs")
            if [[ -z "$LFS_CHECK" ]]; then
                echo -e "${YELLOW}[WARN] Large file not tracked by LFS: $file (${SIZE}KB)${NC}"
                WARNING_COUNT=$((WARNING_COUNT + 1))
            fi
        fi
    fi
done

# ============================================
# Summary
# ============================================
echo ""
echo "=== Pre-commit Check Summary ==="
if [[ $ERROR_COUNT -eq 0 ]] && [[ $WARNING_COUNT -eq 0 ]]; then
    echo -e "${GREEN}All checks passed!${NC}"
    exit 0
elif [[ $ERROR_COUNT -eq 0 ]]; then
    echo -e "${YELLOW}Passed with $WARNING_COUNT warning(s)${NC}"
    exit 0
else
    echo -e "${RED}FAILED: $ERROR_COUNT error(s), $WARNING_COUNT warning(s)${NC}"
    echo ""
    echo "To fix missing meta files:"
    echo "  1. Open Unity and let it generate meta files"
    echo "  2. Stage the new meta files: git add *.meta"
    echo ""
    echo "To bypass this check (not recommended):"
    echo "  git commit --no-verify"
    exit 1
fi
